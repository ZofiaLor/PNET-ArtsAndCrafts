@page "/bookmarks"
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using ArtsAndCrafts.Data
@using ArtsAndCrafts.Models
@inject IDbContextFactory<ArtsAndCrafts.Data.ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider _authenticationStateProvider

<h3>Bookmarks</h3>

@if (user is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4 border-end">
            <h4>Patterns</h4> <hr />
            <div class="list-group list-group-flush">
                @foreach (var p in user.BookmarkedPatterns)
                {
                    <a href="@($"patterns/details?id={p.PatternId}")" class="list-group-item list-group-item-action">
                        @p.Pattern.Name
                        @if (p.IsLiked)
                        {
                            @(" ")
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill text-danger" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
                            </svg>
                        }
                        @if (p.IsDone)
                        {
                            @(" ")
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle-fill text-success" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                            </svg>
                        }
                    </a>
                }
            </div>
        </div>
        <div class="col-md-4 border-end">
            <h4>Tools</h4> <hr />
            <div class="list-group list-group-flush">
                @foreach (var t in user.BookmarkedTools)
                {
                    <a href="@($"tools/details?id={t.ToolId}")" class="list-group-item list-group-item-action">
                        @t.Tool.Name
                        @if (t.IsOwned)
                        {
                            @(" ")
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill text-success" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z" />
                            </svg>
                        }
                    </a>
                }
            </div>
        </div>
        <div class="col-md-4">
            <h4>Yarn</h4> <hr />
            <div class="list-group list-group-flush">
                @foreach (var y in user.BookmarkedYarns)
                {
                    <a href="@($"yarns/details?id={y.YarnId}")" class="list-group-item list-group-item-action">
                        @y.Yarn.Name
                        @if (y.IsOwned)
                        {
                            @(" ")
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-check-fill text-success" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0m-.646 5.354a.5.5 0 0 0-.708-.708L7.5 10.793 6.354 9.646a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0z" />
                            </svg>
                        }
                    </a>
                }
            </div>
        </div>
    </div>
}

@code {
    private ApplicationUser user = default!;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        var username = (await _authenticationStateProvider.GetAuthenticationStateAsync()).User.Identity.Name;
        user = await context.Users.Include(u => u.BookmarkedPatterns).ThenInclude(p => p.Pattern).Include(u => u.BookmarkedTools).ThenInclude(t => t.Tool).Include(u => u.BookmarkedYarns).ThenInclude(y => y.Yarn).Where(u => u.UserName == username).FirstOrDefaultAsync();
    }
}
