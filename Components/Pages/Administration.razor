@page "/administration"
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@using ArtsAndCrafts.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ArtsAndCrafts.Data.ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider _authenticationStateProvider
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime


<h3>Administration</h3>


@if (users.Count() == 0)
{
    <div>Loading...</div>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr class ="table-primary">
                <th scope="col">Username</th>
                <th scope="col">Email</th>
                <th scope="col">Admin privilege</th>
                <th scope="col">Edit privilege</th>
                <th scope="col">Delete user account</th>
            </tr>
        </thead>
        <tbody class="table-group-divider">
            @foreach(var userRole in users)
            {
                <tr>
                    <td>@userRole.user.UserName</td>
                    <td>@userRole.user.Email</td>
                    @if (userRole.isAdmin)
                    {
                        <td class="table-success">Yes</td>
                        @if (currentUser.Id == userRole.user.Id)
                        {
                            <td></td>
                        }
                        else
                        {
                            <td>
                                <button type="button" class="btn btn-danger" @onclick="@(e => ChangePrivileges(userRole))">Remove admin privilege</button>
                            </td>
                        }
                    }
                    else
                    {
                        <td>No</td>
                        <td>
                            <button type="button" class="btn btn-success" @onclick="@(e => ChangePrivileges(userRole))">Grant admin privilege</button>
                        </td>
                    }
                    <td>
                        <button type="button" class="btn btn-danger" @onclick="@(e => DeleteUser(userRole.user))">Delete user</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}




@code {
    private record class UserRole
    {
        public ApplicationUser user;
        public bool isAdmin;
        public UserRole(ApplicationUser user, bool isAdmin)
        {
            this.user = user;
            this.isAdmin = isAdmin;
        }
    }
    List<UserRole> users = new List<UserRole>();
    ApplicationUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        var username = (await _authenticationStateProvider.GetAuthenticationStateAsync()).User.Identity.Name;
        currentUser = await UserManager.FindByNameAsync(username);
        var applicationUsers = UserManager.Users.ToList();
        foreach(var user in applicationUsers)
        {
            var role = await UserManager.IsInRoleAsync(user, "Admin");
            users.Add(new UserRole(user, role));
        }
    }

    async Task ChangePrivileges(UserRole userRole)
    {
        bool isInRole = await UserManager.IsInRoleAsync(userRole.user, "Admin");
        if (isInRole)
        {
            await UserManager.RemoveFromRoleAsync(userRole.user, "Admin");
            userRole.isAdmin = false;
        }
        else
        {
            await UserManager.AddToRoleAsync(userRole.user, "Admin");
            userRole.isAdmin = true;
        }
        StateHasChanged();
    }

    async Task DeleteUser(ApplicationUser user)
    {
        bool confirmed = await JsRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete user {user.UserName}?");
        if (confirmed)
        {
            using var context = DbFactory.CreateDbContext();
            await DeleteUserDataHelper.DeleteUserData(user, context);
            await UserManager.DeleteAsync(user);
            NavigationManager.NavigateTo("/administration", true);
        }
    }

}
