@page "/tools"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using ArtsAndCrafts.Models
@using ArtsAndCrafts.Data
@implements IAsyncDisposable
@inject IDbContextFactory<ArtsAndCrafts.Data.ApplicationDbContext> DbFactory

<PageTitle>Tools</PageTitle>

<h1>Tools</h1>

<AuthorizeView Roles="Admin">
    <p>
        <a href="tools/create">Create New</a>
    </p>
</AuthorizeView>

<div>
    <form action="/tools" data-enhance>
        <label for="nameSearch">Name</label>
        <input type="search" name="nameFilter" id="nameSearch" />
        <label for="materialSearch">Material</label>
        <input type="search" name="materialFilter" id="materialSearch" />
        <label for="typeSearch">Type</label>
        <input type="search" name="typeFilter" id="typeSearch" />
        <label for="brandSearch">Brand</label>
        <input type="search" name="brandFilter" id="brandSearch" />
        <label for="sizeSearch">Size</label>
        <input type="search" name="sizeFilter" id="sizeSearch" pattern="\d*(\.(\d+))?" />
        <input type="submit" class="btn btn-info" value="Search" />
        <input type="reset" class="btn btn-warning" value="Clear filters">
    </form>
</div>

<QuickGrid Class="table" Items="filteredTools" Pagination="pagination">
    <PropertyColumn Property="tool => tool.Name" Sortable="true" />
    <PropertyColumn Property="tool => tool.Material" />
    <PropertyColumn Property="tool => tool.Type" />
    <PropertyColumn Property="tool => tool.Brand" />
    <PropertyColumn Property="tool => tool.Size" />

    <TemplateColumn Context="tool">
        <a href="@($"tools/details?id={tool.Id}")">Details</a>
        <AuthorizeView Roles="Admin">
            | <a href="@($"tools/edit?id={tool.Id}")">Edit</a> |
            <a href="@($"tools/delete?id={tool.Id}")">Delete</a>
        </AuthorizeView>
    </TemplateColumn>
</QuickGrid>
<Paginator State="pagination" />

@code {
    private ApplicationDbContext context = default!;

    private PaginationState pagination = new PaginationState { ItemsPerPage = 5 };

    [SupplyParameterFromQuery]
    private string? NameFilter { get; set; }
    [SupplyParameterFromQuery]
    private string? MaterialFilter { get; set; }
    [SupplyParameterFromQuery]
    private string? TypeFilter { get; set; }
    [SupplyParameterFromQuery]
    private string? BrandFilter { get; set; }
    [SupplyParameterFromQuery]
    private float? SizeFilter { get; set; }

    private IQueryable<Tool> filteredTools =>
    context.Tools.Where(t => t.Name.Contains(NameFilter ?? string.Empty) && t.Material.Contains(MaterialFilter ?? string.Empty) && t.Type.Contains(TypeFilter ?? string.Empty) && t.Brand.Contains(BrandFilter ?? string.Empty) && t.Size.Equals(SizeFilter ?? t.Size));

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
