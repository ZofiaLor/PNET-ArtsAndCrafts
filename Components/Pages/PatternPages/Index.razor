@page "/patterns"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using ArtsAndCrafts.Models
@using ArtsAndCrafts.Data
@implements IAsyncDisposable
@inject IDbContextFactory<ArtsAndCrafts.Data.ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider _authenticationStateProvider

<PageTitle>Patterns</PageTitle>

<h1>Patterns</h1>

<p>
    <AuthorizeView>
        <Authorized>
            <a href="patterns/create">Create New</a>
        </Authorized>
        <NotAuthorized>
            <p>Log in to create your own patterns</p>
        </NotAuthorized>
    </AuthorizeView>
</p>

<div>
    @if (user is not null)
    {
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault" @bind="matchMine">
            <label class="form-check-label" for="switchCheckDefault">Match to bookmarks</label>
        </div>
    }
    
    @if (matchMine)
    {
        <form action="/patterns" data-enhance>
            <InputRadioGroup @bind-Value="onlyOwned">
                <label>
                    <InputRadio Value="false" />
                    Match all bookmarks
                </label>
                <label>
                    <InputRadio Value="true" />
                    Match only owned
                </label>
            </InputRadioGroup>
            <hr />
            <h4>Yarn matchers</h4>
            <label>
                <input @bind="matchYarnMaterial" type="checkbox" />
                Material
            </label>
            <label>
                <input @bind="matchYarnColor" type="checkbox" />
                Color
            </label>
            <label>
                <input @bind="matchYarnBrand" type="checkbox" />
                Brand
            </label>
            <label>
                <input @bind="matchYarnWeight" type="checkbox" />
                Weight
            </label>
            <hr/>
            <h4>Tool matchers</h4>
            <label>
                <input @bind="matchToolType" type="checkbox" />
                Tool type
            </label>
            <label>
                <input @bind="matchToolSize" type="checkbox" />
                Size
            </label>
            <hr />
            <input type="button" class="btn btn-info" @onclick="Filter" value="Filter" />
        </form>
    }
    else
    {
        <form action="/patterns" data-enhance>
            <h4>Yarn filters</h4>
        <label>
            Material
            <input type="text" @bind="MaterialFilter" />
        </label>
        <label>
            Color
            <input type="text" @bind="ColorFilter" />
        </label>
        <label>
            Brand
            <input type="text" @bind="BrandFilter" />
        </label>
        <label>
            Weight
            <input type="number" @bind="WeightFilter" min="0"/>
        </label>
        <hr />
        <h4>Tool filters</h4>
        <label>
            Tool type
            <input type="text" @bind="ToolTypeFilter" />
        </label>
        <label>
            Size
                <input type="number" @bind="SizeFilter" min="0" step="0.01" />
        </label>
        <hr />
        <input type="button" class="btn btn-info" @onclick="Filter" value="Search" />
        <input type="button" class="btn btn-warning" @onclick="Clear" value="Clear filters">
        </form>
    }

</div>

<QuickGrid Class="table" Items="filteredPatterns">
    <PropertyColumn Property="pattern => pattern.Name" Sortable="true" />
    <PropertyColumn Property="pattern => pattern.Type" />
    <PropertyColumn Property="pattern => pattern.Author.UserName" />

    <TemplateColumn Context="pattern">
        <a href="@($"patterns/details?id={pattern.Id}")">View pattern</a>
    </TemplateColumn>
</QuickGrid>

@code {
    private ApplicationDbContext? context;
    private IQueryable<Pattern> patterns;
    private IQueryable<Pattern> filteredPatterns;
    private ApplicationUser? user;


    private bool matchMine = false;
    private bool onlyOwned = false;

    private bool matchYarnMaterial = false;
    private bool matchYarnColor = false;
    private bool matchYarnBrand = false;
    private bool matchYarnWeight = false;

    private bool matchToolType = false;
    private bool matchToolSize = false;

    private string? MaterialFilter { get; set; }
    private string? ColorFilter { get; set; }
    private string? BrandFilter { get; set; }
    private int? WeightFilter { get; set; }

    private string? ToolTypeFilter { get; set; }
    private float? SizeFilter { get; set; }

    protected override async void OnInitialized()
    {
        context ??= DbFactory.CreateDbContext();
        var claims = (await _authenticationStateProvider.GetAuthenticationStateAsync()).User.Identity;
        if (claims is not null && claims.IsAuthenticated)
        {
            user = context.Users.Include(u => u.BookmarkedTools).ThenInclude(t => t.Tool).Include(u => u.BookmarkedYarns).ThenInclude(y => y.Yarn).Where(u => u.UserName == claims.Name).FirstOrDefault();
        }
        patterns = context.Patterns.Include(p => p.Author).Include(p => p.Yarns).Include(p => p.Tools);
        filteredPatterns = patterns;
    }

    private void Filter()
    {
        if (matchMine && user is not null)
        {
            var materials = user.BookmarkedYarns.Where(y => onlyOwned ? y.IsOwned : true).Select(y => y.Yarn.Material.ToUpper());
            var colors = user.BookmarkedYarns.Where(y => onlyOwned ? y.IsOwned : true).Select(y => y.Yarn.Color.ToUpper());
            var brands = user.BookmarkedYarns.Where(y => onlyOwned ? y.IsOwned : true).Select(y => y.Yarn.Brand.ToUpper());
            var weights = user.BookmarkedYarns.Where(y => onlyOwned ? y.IsOwned : true).Select(y => y.Yarn.Weight);
            var types = user.BookmarkedTools.Where(t => onlyOwned ? t.IsOwned : true).Select(t => t.Tool.Type.ToUpper());
            var sizes = user.BookmarkedTools.Where(t => onlyOwned ? t.IsOwned : true).Select(t => t.Tool.Size);
            filteredPatterns = patterns.Where(p => (matchYarnMaterial ? p.Yarns.Select(y => y.Material).Any(material => materials.Contains(material.ToUpper())) : true) &&
                (matchYarnColor ? p.Yarns.Select(y => y.Color).Any(color => colors.Contains(color.ToUpper())) : true) &&
                (matchYarnBrand ? p.Yarns.Select(y => y.Brand).Any(brand => brands.Contains(brand.ToUpper())) : true) &&
                (matchYarnWeight ? p.Yarns.Select(y => y.Weight).Any(weight => weights.Contains(weight)) : true) &&
                (matchToolType ? p.Tools.Select(t => t.Type).Any(type => types.Contains(type.ToUpper())) : true) &&
                (matchToolSize ? p.Tools.Select(t => t.Size).Any(size => sizes.Contains(size)) : true));
        }
        else
        {
            filteredPatterns = patterns.Where(p => (MaterialFilter == null ? true : p.Yarns.Select(y => y.Material).Any(material => material.ToUpper().Contains(MaterialFilter.ToUpper()))) &&
                (ColorFilter == null ? true : p.Yarns.Select(y => y.Color).Any(color => color.ToUpper().Contains(ColorFilter.ToUpper()))) &&
                (BrandFilter == null ? true : p.Yarns.Select(y => y.Brand).Any(brand => brand.ToUpper().Contains(BrandFilter.ToUpper()))) &&
                (WeightFilter == null ? true : p.Yarns.Select(y => y.Weight).Any(weight => weight.Equals(WeightFilter))) &&
                (ToolTypeFilter == null ? true : p.Tools.Select(t => t.Type).Any(type => type.ToUpper().Contains(ToolTypeFilter.ToUpper()))) &&
                (SizeFilter == null ? true : p.Tools.Select(t => t.Size).Any(size => size.Equals(SizeFilter))));

        }
    }

    private void Clear()
    {
        MaterialFilter = null;
        ColorFilter = null;
        BrandFilter = null;
        WeightFilter = null;
        ToolTypeFilter = null;
        SizeFilter = null;
    }

    public async ValueTask DisposeAsync() {
        if (context is not null) 
            await context.DisposeAsync();
    }
}
